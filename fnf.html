<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini FNF Ultra Engine v2.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; }
        
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .config-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; border: 1px solid #444; width: 320px; margin-bottom: 10px; text-align: center; }
        
        .btn { border: none; padding: 12px; color: white; font-weight: bold; cursor: pointer; margin: 5px 0; border-radius: 8px; width: 100%; font-size: 14px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); opacity: 0.8; }
        .btn-cyan { background: #00ffff; color: #000; }
        .btn-green { background: #12FA05; color: #000; }
        .btn-red { background: #ff4444; }
        .btn-zip { background: #ffaa00; color: #000; }

        #game-ui { position: absolute; top: 15px; width: 100%; text-align: center; display: none; z-index: 60; pointer-events: none; }
        .hp-text { font-size: 28px; font-weight: bold; color: #12FA05; text-shadow: 2px 2px #000; }
        
        #editor-ui { position: absolute; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); padding: 10px; display: none; z-index: 65; }

        video { position: fixed; inset: 0; z-index: -1; width: 100%; height: 100%; object-fit: cover; filter: brightness(0.4); display: none; }
        canvas { display: none; background: transparent; }
        
        /* HITBOXES ANDROID */
        #mobile-btns { position: absolute; inset: 0; display: none; grid-template-columns: repeat(4, 1fr); z-index: 40; }
        .touch-zone { 
            height: 100%; 
            border: 1px solid rgba(255,255,255,0.05); 
            display: flex; align-items: flex-end; justify-content: center;
            padding-bottom: 50px; font-size: 40px; font-weight: bold;
        }
        .zone-0 { background: rgba(194, 75, 153, 0.15); color: #C24B99; }
        .zone-1 { background: rgba(0, 255, 255, 0.15); color: #00FFFF; }
        .zone-2 { background: rgba(18, 250, 5, 0.15); color: #12FA05; }
        .zone-3 { background: rgba(249, 57, 63, 0.15); color: #F9393F; }
        .touch-zone:active { background: rgba(255,255,255,0.3) !important; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="menu-main" class="overlay">
        <h1 style="color:#00ffff;">FNF ULTRA ENGINE</h1>
        
        <div class="config-card">
            <small>ARQUIVOS INDIVIDUAIS</small>
            <input type="file" id="videoFile" accept="video/mp4" style="width:100%; margin: 5px 0;">
            <input type="file" id="chartFile" accept=".json" style="width:100%; margin-bottom: 10px;">
            <button class="btn btn-green" onclick="startApp('play', false)">JOGAR</button>
            <button class="btn btn-cyan" onclick="startApp('edit', false)">EDITOR</button>
        </div>

        <div class="config-card">
            <small>FASE PRONTA (.ZIP)</small>
            <input type="file" id="zipFile" accept=".zip" style="width:100%; margin: 5px 0;">
            <button class="btn btn-zip" onclick="startApp('play', true)">CARREGAR ZIP</button>
        </div>

        <button class="btn" style="background:#333; width:320px;" onclick="showSettings(true)">⚙️ CONFIGURAÇÕES</button>
    </div>

    <div id="menu-settings" class="overlay hidden">
        <h2>AJUSTES</h2>
        <div class="config-card">
            <p>PLATAFORMA: <b id="display-platform">PC</b></p>
            <button class="btn btn-cyan" onclick="togglePlatform()">TROCAR PLATAFORMA</button>
            <p>GHOST TAP: <b id="display-ghost">OFF</b></p>
            <button class="btn btn-cyan" onclick="toggleGhostTap()">LIGAR/DESLIGAR</button>
        </div>
        <button class="btn btn-red" style="width:320px;" onclick="showSettings(false)">VOLTAR</button>
    </div>

    <div id="game-ui"><div class="hp-text">VIDA: <span id="hp-val">100</span></div></div>

    <div id="editor-ui">
        <button class="btn" style="width:auto;" onclick="video.paused ? video.play() : video.pause()">P/P</button>
        <button class="btn btn-red" style="width:auto;" onclick="exportZip()">SALVAR ZIP</button>
    </div>

    <div id="mobile-btns">
        <div class="touch-zone zone-0" onpointerdown="handleInput(0)">A</div>
        <div class="touch-zone zone-1" onpointerdown="handleInput(1)">S</div>
        <div class="touch-zone zone-2" onpointerdown="handleInput(2)">W</div>
        <div class="touch-zone zone-3" onpointerdown="handleInput(3)">D</div>
    </div>

    <video id="video-main" playsinline></video>
    <canvas id="canvas-game"></canvas>

    <script>
        let mode = 'play';
        let platform = 'PC';
        let ghostTap = false;
        let chart = { notes: [], speed: 4 };
        let hp = 100;
        let videoBlob = null;
        
        let receptorScales = [1, 1, 1, 1];
        let receptorAlpha = [0.3, 0.3, 0.3, 0.3];

        const video = document.getElementById('video-main');
        const canvas = document.getElementById('canvas-game');
        const ctx = canvas.getContext('2d');
        const colors = ['#C24B99', '#00FFFF', '#12FA05', '#F9393F'];

        function showSettings(open) {
            document.getElementById('menu-main').classList.toggle('hidden', open);
            document.getElementById('menu-settings').classList.toggle('hidden', !open);
        }

        function togglePlatform() {
            platform = (platform === 'PC') ? 'ANDROID' : 'PC';
            document.getElementById('display-platform').innerText = platform;
        }

        function toggleGhostTap() {
            ghostTap = !ghostTap;
            document.getElementById('display-ghost').innerText = ghostTap ? "ON" : "OFF";
        }

        function drawArrow(x, y, lane, scale, alpha, isNote = false) {
            ctx.save();
            ctx.translate(x + 35, y + 35);
            ctx.scale(scale, scale); 
            const rotations = [-Math.PI/2, Math.PI, 0, Math.PI/2];
            ctx.rotate(rotations[lane]);
            ctx.beginPath();
            ctx.moveTo(0, -25); ctx.lineTo(20, 0); ctx.lineTo(10, 0);
            ctx.lineTo(10, 25); ctx.lineTo(-10, 25); ctx.lineTo(-10, 0);
            ctx.lineTo(-20, 0); ctx.closePath();
            ctx.fillStyle = isNote ? colors[lane] : `rgba(${hexToRgb(colors[lane])}, ${alpha})`;
            ctx.strokeStyle = isNote ? 'white' : `rgba(255,255,255,${alpha + 0.2})`;
            ctx.lineWidth = 3;
            ctx.fill(); ctx.stroke();
            ctx.restore();
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r},${g},${b}`;
        }

        async function startApp(targetMode, isZip) {
            mode = targetMode;
            if(isZip) {
                const file = document.getElementById('zipFile').files[0];
                if(!file) return alert("Selecione o arquivo ZIP!");
                const zip = new JSZip();
                const contents = await zip.loadAsync(file);
                for (let name in contents.files) {
                    if(name.endsWith('.mp4')) {
                        const blob = await contents.files[name].async("blob");
                        video.src = URL.createObjectURL(blob); videoBlob = blob;
                    }
                    if(name.endsWith('.json')) {
                        const text = await contents.files[name].async("string");
                        chart = JSON.parse(text);
                    }
                }
            } else {
                const vFile = document.getElementById('videoFile').files[0];
                const cFile = document.getElementById('chartFile').files[0];
                if(!vFile) return alert("Selecione um vídeo!");
                videoBlob = vFile; video.src = URL.createObjectURL(vFile);
                if(cFile) {
                    const text = await cFile.text();
                    const data = JSON.parse(text);
                    chart.notes = [];
                    const src = data.song ? data.song.notes : data.notes;
                    src.forEach(s => s.sectionNotes.forEach(n => {
                        chart.notes.push({ time: n[0]/1000, lane: Math.floor(n[1]%4), hit: false, missed: false });
                    }));
                }
            }
            launch();
        }

        function launch() {
            document.getElementById('menu-main').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            canvas.style.display = 'block'; video.style.display = 'block';
            if(platform === 'ANDROID') document.getElementById('mobile-btns').style.display = 'grid';
            if(mode === 'edit') document.getElementById('editor-ui').style.display = 'block';
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            video.play();
            requestAnimationFrame(update);
        }

        function handleInput(lane) {
            receptorScales[lane] = 1.3;
            receptorAlpha[lane] = 1.0;
            if(mode === 'play') {
                const note = chart.notes.find(n => !n.hit && n.lane === lane && Math.abs(n.time - video.currentTime) < 0.16);
                if(note) { note.hit = true; hp = Math.min(100, hp + 2.5); }
                else if(!ghostTap) { hp -= 2; }
            } else {
                chart.notes.push({ time: video.currentTime, lane: lane, hit: false, missed: false });
            }
        }

        function update() {
            if(hp <= 0) { alert("GAME OVER"); location.reload(); return; }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('hp-val').innerText = Math.floor(hp);
            const lanesX = [canvas.width/2-150, canvas.width/2-50, canvas.width/2+50, canvas.width/2+150];
            lanesX.forEach((x, i) => {
                receptorScales[i] += (1 - receptorScales[i]) * 0.2;
                receptorAlpha[i] += (0.3 - receptorAlpha[i]) * 0.2;
                drawArrow(x, 80, i, receptorScales[i], receptorAlpha[i], false);
            });
            chart.notes.forEach(note => {
                if(note.hit) return;
                let timeDiff = note.time - video.currentTime;
                if(timeDiff < -0.2 && !note.missed) { note.missed = true; hp -= 8; }
                if(timeDiff < 2 && timeDiff > -0.2) {
                    let y = 80 + (timeDiff * chart.speed * 180);
                    drawArrow(lanesX[note.lane], y, note.lane, 1, 1, true);
                }
            });
            requestAnimationFrame(update);
        }

        window.addEventListener('keydown', (e) => {
            const keys = {'ArrowLeft':0,'ArrowDown':1,'ArrowDown':1,'ArrowUp':2,'ArrowRight':3, 'KeyA':0, 'KeyS':1, 'KeyW':2, 'KeyD':3};
            if(keys[e.code] !== undefined) handleInput(keys[e.code]);
        });

        async function exportZip() {
            const zip = new JSZip();
            zip.file("chart.json", JSON.stringify(chart));
            zip.file("video.mp4", videoBlob);
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "projeto_fnf.zip");
        }
    </script>
</body>
</html>

