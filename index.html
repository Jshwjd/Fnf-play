<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FNF Extra Keys - v8.6 Touch Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; touch-action: none; -webkit-user-select: none; }
        .overlay { position: absolute; inset: 0; background: linear-gradient(180deg, #0b011d 0%, #000 100%); display: flex; flex-direction: column; align-items: center; z-index: 100; padding: 20px; overflow-y: auto; }
        .config-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; width: 90%; max-width: 340px; margin-bottom: 10px; border: 1px solid #333; }
        .btn { border: none; padding: 10px; color: white; font-weight: bold; cursor: pointer; border-radius: 8px; width: 100%; text-transform: uppercase; font-size: 9px; margin: 2px 0; transition: 0.2s; text-align: center;}
        .btn-cyan { background: #00ffff; color: #000; }
        .btn-green { background: #12FA05; color: #000; }
        .btn-purple { background: #a29bfe; color: #000; }
        .btn-red { background: #ff4444; color: white; }
        .btn-orange { background: #ff7f00; color: #000; }
        
        #settings-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; border: 2px solid #00ffff; padding: 20px; border-radius: 20px; z-index: 200; display: none; width: 280px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; font-size: 11px; }

        #editor-ui { position: absolute; bottom: 5px; left: 5px; right: 5px; display: none; z-index: 70; flex-direction: column; background: rgba(0,0,0,0.92); padding: 10px; border-radius: 12px; border: 1px solid #00ffff; }
        .editor-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; gap: 5px; }
        .input-text { background: #1a1a1a; border: 1px solid #00ffff; color: #00ffff; padding: 5px; border-radius: 5px; width: 45px; text-align: center; font-size: 11px; }
        #timeline-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; margin: 5px 0; cursor: pointer; position: relative; }
        #timeline-fill { height: 100%; background: #ff0000; width: 0%; border-radius: 4px; }
        
        video { position: fixed; inset: 0; z-index: -1; width: 100%; height: 100%; object-fit: cover; filter: brightness(0.4); display: none; }
        canvas { display: none; pointer-events: none; }
        
        #mobile-btns { position: absolute; inset: 0; display: none; z-index: 40; width: 100%; height: 100%; }
        .touch-zone { flex: 1; height: 100%; transition: background 0.1s; border-right: 1px solid rgba(255,255,255,0.05); pointer-events: auto; }

        #ui-layer { position: absolute; bottom: 100px; width: 100%; text-align: center; pointer-events: none; z-index: 85; display: none; }
        .stats { font-size: 14px; font-weight: bold; text-shadow: 2px 2px #000; }

        #health-container { position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%); width: 250px; height: 10px; background: #ff4444; border: 2px solid #fff; border-radius: 5px; z-index: 80; display: none; overflow: hidden; }
        #health-bar { height: 100%; width: 50%; background: #12FA05; float: right; }
    </style>
</head>
<body>

    <div id="menu-main" class="overlay">
        <h1 style="color:#00ffff; margin-bottom: 20px; font-size: 24px;">FNF EXTRA KEYS</h1>
        <div class="config-card">
            <button class="btn btn-purple" id="btn-key-mode" onclick="cycleKeys()">4 SETAS</button>
            <button class="btn btn-green" onclick="startApp('play', true)">JOGAR ZIP</button>
            <input type="file" id="zipFile" accept=".zip" style="display:none">
        </div>
        <div class="config-card">
            <input type="file" id="videoFile" accept="video/mp4" style="width:100%; margin-bottom: 5px;">
            <button class="btn btn-cyan" onclick="startApp('edit', false)">MODO EDITOR</button>
        </div>
        <button class="btn btn-purple" style="width: 200px;" onclick="toggleSettings(true)">⚙️ CONFIGURAÇÕES</button>
    </div>

    <div id="settings-modal">
        <h3 style="text-align:center; color:#00ffff; margin:0 0 10px 0;">AJUSTES</h3>
        <div class="setting-row"><span>DANO INIMIGO:</span><button id="set-enemyDmg" class="btn btn-green" onclick="toggleSet('enemyDmg')">ON</button></div>
        <div class="setting-row"><span>GHOST TAPPING:</span><button id="set-ghostTap" class="btn btn-green" onclick="toggleSet('ghostTap')">ON</button></div>
        <div class="setting-row"><span>IMORTAL:</span><button id="set-immortal" class="btn btn-red" onclick="toggleSet('immortal')">OFF</button></div>
        <div class="setting-row"><span>AUTO-BOT:</span><button id="set-auto" class="btn btn-red" onclick="toggleSet('auto')">OFF</button></div>
        <button class="btn btn-red" onclick="toggleSettings(false)" style="width:100%">FECHAR</button>
    </div>

    <div id="ui-layer"><div id="score-text" class="stats">Score: 0 | Combo: 0</div></div>
    <div id="health-container"><div id="health-bar"></div></div>
    <button id="btn-exit" class="btn btn-red" style="position:fixed; top:10px; left:10px; width:40px; display:none; z-index:110;" onclick="location.reload()">X</button>

    <div id="editor-ui">
        <div id="timeline-bg" onclick="seekVideo(event)"><div id="timeline-fill"></div></div>
        <div class="editor-row">
            <button id="btn-side-toggle" class="btn btn-orange" style="width:40%" onclick="toggleSide()">INIMIGO</button>
            <div style="display: flex; gap: 5px;">
                <div style="text-align:center"><span style="font-size:7px">SPD</span><br><input type="number" id="speed-input" class="input-text" value="2.5" step="0.1" onchange="updateSPD(this.value)"></div>
                <div style="text-align:center"><span style="font-size:7px">V-SPD</span><br><input type="number" id="v-speed-input" class="input-text" value="1.0" step="0.1" onchange="updateVideoSpeed(this.value)"></div>
            </div>
        </div>
        <div class="editor-row">
            <button class="btn btn-cyan" style="width:25%" onclick="togglePlay()">PLAY</button>
            <button class="btn btn-purple" style="width:35%" onclick="document.getElementById('psychInput').click()">PSYCH</button>
            <button class="btn btn-green" style="width:35%" onclick="exportProject()">SALVAR ZIP</button>
        </div>
        <input type="file" id="psychInput" accept=".json" style="display:none" onchange="importPsychChart(this)">
    </div>

    <div id="mobile-btns"></div>
    <video id="video-main" playsinline preload="auto"></video>
    <canvas id="canvas-game"></canvas>

    <script>
        let keyCount = 4, mode = 'play', side = 'player', scrollSpeed = 2.5, health = 100;
        let score = 0, combo = 0;
        let settings = { enemyDmg: true, immortal: false, auto: false, ghostTap: true };
        let chart = { notes: [], keyMode: 4, speed: 2.5 };
        let activeLongNotes = {}; 
        let receptorScales = { player: [], opponent: [] };
        let currentVideoBlob = null;
        
        const video = document.getElementById('video-main');
        const canvas = document.getElementById('canvas-game');
        const ctx = canvas.getContext('2d');

        const keyConfigs = {
            4: { colors: ['#C24B99', '#00FFFF', '#12FA05', '#F9393F'], angles: [Math.PI/2, 0, Math.PI, -Math.PI/2] },
            6: { colors: ['#C24B99', '#12FA05', '#F9393F', '#C24B99', '#00FFFF', '#F9393F'], angles: [Math.PI/2, Math.PI, -Math.PI/2, Math.PI/2, 0, -Math.PI/2] },
            9: { colors: ['#C24B99', '#00FFFF', '#12FA05', '#F9393F', '#FFFFFF', '#C24B99', '#00FFFF', '#12FA05', '#F9393F'], angles: [Math.PI/2, 0, Math.PI, -Math.PI/2, 0, Math.PI/2, 0, Math.PI, -Math.PI/2] }
        };

        const layouts = {
            4: { 'a':0, 's':1, 'w':2, 'd':3, 'arrowleft':0, 'arrowdown':1, 'arrowup':2, 'arrowright':3 },
            6: { 's':0, 'd':1, 'f':2, 'j':3, 'k':4, 'l':5 },
            9: { 'a':0, 's':1, 'd':2, 'f':3, ' ':4, 'h':5, 'j':6, 'k':7, 'l':8 }
        };

        // TECLADO
        window.addEventListener('keydown', e => { 
            let k = e.key.toLowerCase();
            let layout = layouts[keyCount];
            if(layout[k] !== undefined) {
                let lane = layout[k];
                if(!activeLongNotes[lane]) {
                    receptorScales.player[lane] = 1.4;
                    startInput(lane);
                }
            }
        });
        window.addEventListener('keyup', e => {
            let k = e.key.toLowerCase();
            let layout = layouts[keyCount];
            if(layout[k] !== undefined) {
                let lane = layout[k];
                receptorScales.player[lane] = 1.0;
                endInput(lane);
            }
        });

        function cycleKeys() {
            keyCount = keyCount === 4 ? 6 : (keyCount === 6 ? 9 : 4);
            document.getElementById('btn-key-mode').innerText = keyCount + " SETAS";
            chart.keyMode = keyCount;
        }

        function toggleSettings(s) { document.getElementById('settings-modal').style.display = s ? 'block' : 'none'; }
        function toggleSet(k) { 
            settings[k] = !settings[k]; 
            const b = document.getElementById('set-'+k);
            b.innerText = settings[k] ? "ON" : "OFF";
            b.className = settings[k] ? "btn btn-green" : "btn btn-red";
        }
        function toggleSide() {
            side = side === 'player' ? 'opponent' : 'player';
            document.getElementById('btn-side-toggle').innerText = side === 'player' ? "INIMIGO" : "JOGADOR";
        }
        function updateSPD(v) { scrollSpeed = parseFloat(v); chart.speed = scrollSpeed; }
        function updateVideoSpeed(v) { video.playbackRate = parseFloat(v); }

        async function startApp(m, isZip) {
            mode = m;
            if(isZip) {
                const file = document.getElementById('zipFile').files[0];
                if(!file) { document.getElementById('zipFile').click(); return; }
                const zip = new JSZip(); const contents = await zip.loadAsync(file);
                for (let filename in contents.files) {
                    if (filename.endsWith('.mp4')) { currentVideoBlob = await contents.files[filename].async("blob"); video.src = URL.createObjectURL(currentVideoBlob); }
                    if (filename.endsWith('.json')) { 
                        chart = JSON.parse(await contents.files[filename].async("string")); 
                        keyCount = chart.keyMode || 4; scrollSpeed = chart.speed || 2.5;
                    }
                }
            } else {
                const vFile = document.getElementById('videoFile').files[0];
                if(!vFile) return;
                currentVideoBlob = vFile; video.src = URL.createObjectURL(currentVideoBlob);
                chart.keyMode = keyCount; chart.notes = [];
            }
            receptorScales.player = Array(keyCount).fill(1);
            receptorScales.opponent = Array(keyCount).fill(1);
            document.getElementById('menu-main').style.display = 'none';
            document.getElementById('btn-exit').style.display = 'block';
            if(mode === 'play') { document.getElementById('health-container').style.display = 'block'; document.getElementById('ui-layer').style.display = 'block'; }
            if(mode === 'edit') document.getElementById('editor-ui').style.display = 'flex';
            canvas.style.display = 'block'; video.style.display = 'block';
            setupMobile(); canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            video.play(); updateLoop();
        }

        function setupMobile() {
            const container = document.getElementById('mobile-btns'); container.innerHTML = ''; container.style.display = 'flex';
            const colors = keyConfigs[keyCount].colors;
            for(let i=0; i<keyCount; i++) {
                const div = document.createElement('div'); div.className = 'touch-zone';
                
                // EVENTOS TOUCH CORRIGIDOS
                div.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    div.style.background = `linear-gradient(to top, ${colors[i]}66, transparent)`;
                    receptorScales.player[i] = 1.4;
                    startInput(i);
                });
                
                div.addEventListener('pointerup', (e) => {
                    e.preventDefault();
                    div.style.background = "transparent";
                    receptorScales.player[i] = 1.0;
                    endInput(i);
                });

                div.addEventListener('pointerleave', (e) => {
                    e.preventDefault();
                    div.style.background = "transparent";
                    receptorScales.player[i] = 1.0;
                    endInput(i);
                });

                container.appendChild(div);
            }
        }

        function startInput(lane) {
            if(mode === 'edit') {
                let n = { time: video.currentTime, lane: lane, duration: 0, hit: false, side: side };
                activeLongNotes[lane] = n; 
                chart.notes.push(n);
            } else if(!settings.auto) {
                const n = chart.notes.find(n => n.side === 'player' && !n.hit && n.lane === lane && Math.abs(n.time - video.currentTime) < 0.16);
                if(n) { n.hit = true; health = Math.min(200, health + 4); score += 350; combo++; } 
                else if(!settings.ghostTap) { health -= 5; combo = 0; }
                updateUI();
            }
        }

        function endInput(lane) { 
            if(mode === 'edit' && activeLongNotes[lane]) { 
                let dur = video.currentTime - activeLongNotes[lane].time;
                activeLongNotes[lane].duration = dur > 0.1 ? dur : 0; 
            } 
            activeLongNotes[lane] = null; 
        }

        function updateUI() { document.getElementById('score-text').innerText = `Score: ${score} | Combo: ${combo}`; }

        function updateLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(mode === 'edit') document.getElementById('timeline-fill').style.width = (video.currentTime / video.duration) * 100 + "%";
            document.getElementById('health-bar').style.width = (health / 200) * 100 + "%";

            const speedMult = scrollSpeed * 180;
            const laneW = (canvas.width * 0.44) / keyCount;
            const leftStart = canvas.width * 0.03;
            const rightStart = canvas.width * 0.53;

            for(let i=0; i<keyCount; i++) {
                receptorScales.player[i] += (1 - receptorScales.player[i]) * 0.2;
                receptorScales.opponent[i] += (1 - receptorScales.opponent[i]) * 0.2;

                drawArrow(leftStart + (i * laneW), 70, i, receptorScales.opponent[i], receptorScales.opponent[i] > 1.1 ? 0.9 : 0.35);
                drawArrow(rightStart + (i * laneW), 70, i, receptorScales.player[i], receptorScales.player[i] > 1.1 ? 0.9 : 0.35);

                if(mode === 'edit' && activeLongNotes[i]) {
                    activeLongNotes[i].duration = video.currentTime - activeLongNotes[i].time;
                }

                chart.notes.forEach(note => {
                    if(note.lane === i) {
                        let diff = note.time - video.currentTime;
                        let x = (note.side === 'player' ? rightStart : leftStart) + (i * laneW);
                        let y = 70 + (diff * speedMult);

                        if(mode === 'play') {
                            if(settings.auto && note.side === 'player' && diff <= 0 && !note.hit) { 
                                note.hit = true; receptorScales.player[i] = 1.35; score += 350; combo++; updateUI();
                            }
                            if(note.side === 'opponent' && diff <= 0 && !note.hit) { 
                                note.hit = true; receptorScales.opponent[i] = 1.35; if(settings.enemyDmg) health -= 2; 
                            }
                        }

                        // LONG NOTES
                        if(note.duration > 0.02) {
                            let endY = 70 + ((note.time + note.duration - video.currentTime) * speedMult);
                            let startY = Math.max(70, y);
                            if(endY > 70 && startY < canvas.height) {
                                ctx.fillStyle = keyConfigs[keyCount].colors[i]; ctx.globalAlpha = 0.4;
                                ctx.fillRect(x - (laneW*0.1), startY, (laneW*0.2), endY - startY);
                                ctx.globalAlpha = 1.0;
                            }
                        }
                        
                        // CABEÇA DA NOTA
                        let isStillActive = (note.duration > 0 && (note.time + note.duration) > video.currentTime);
                        if(y > -50 && y < canvas.height + 50 && (!note.hit || isStillActive)) {
                            drawArrow(x, Math.max(70, y), i, 1, 1);
                        } else if(mode === 'play' && note.side === 'player' && diff < -0.2 && !note.hit) {
                            note.hit = true; health -= 10; combo = 0; updateUI();
                        }
                    }
                });
            }
            if(health <= 0 && !settings.immortal) { alert("GAME OVER"); location.reload(); }
            requestAnimationFrame(updateLoop);
        }

        function drawArrow(x, y, lane, scale, alpha) {
            const baseSize = keyCount === 9 ? 15 : (keyCount === 6 ? 19 : 24);
            const size = baseSize * scale;
            const conf = keyConfigs[keyCount];
            ctx.save(); ctx.translate(x, y); ctx.globalAlpha = alpha;
            ctx.fillStyle = conf.colors[lane] || '#fff'; ctx.rotate(conf.angles[lane]);
            ctx.beginPath();
            ctx.moveTo(-size, size/3); ctx.lineTo(0, -size); ctx.lineTo(size, size/3);
            ctx.lineTo(size/2, size/3); ctx.lineTo(size/2, size); ctx.lineTo(-size/2, size); ctx.lineTo(-size/2, size/3);
            ctx.closePath(); ctx.fill(); 
            ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
            ctx.restore();
        }

        function togglePlay() { video.paused ? video.play() : video.pause(); }
        function seekVideo(e) { const rect = document.getElementById('timeline-bg').getBoundingClientRect(); video.currentTime = ((e.clientX - rect.left) / rect.width) * video.duration; }

        function importPsychChart(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const psych = JSON.parse(e.target.result); chart.notes = [];
                psych.song.notes.forEach(sec => {
                    sec.sectionNotes.forEach(n => {
                        let isPlayer = sec.mustHitSection ? (n[1] < 4) : (n[1] >= 4);
                        chart.notes.push({ time: n[0]/1000, lane: n[1]%keyCount, duration: n[2]/1000, hit: false, side: isPlayer ? 'player' : 'opponent' });
                    });
                });
                alert("Psych Chart Importada!");
            };
            reader.readAsText(input.files[0]);
        }

        async function exportProject() {
            if(!currentVideoBlob) return;
            const zip = new JSZip();
            zip.file("chart.json", JSON.stringify(chart));
            zip.file("video.mp4", currentVideoBlob);
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "projeto_fnf_touch_fixed.zip");
        }
    </script>
</body>
</html>

